<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detection Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0;
    }
    header {
      background-color: #2c3e50;
      color: white;
      text-align: center;
      padding: 1rem;
    }
    .container {
      display: grid;
      grid-template-columns: 1fr;
      gap: 20px;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #map {
      height: 400px;
    }
    .export-btns {
      margin-top: 10px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
  </style>
</head>
<body>
  <header>
    <h1>Bioacoustic Detection Dashboard</h1>
  </header>

  <div class="container">
    <div id="loading" class="loading">Loading data...</div>
    
    <div class="card" style="display:none;" id="speciesCard">
      <h3>Detected Species</h3>
      <canvas id="speciesChart"></canvas>
      <div class="export-btns">
        <button onclick="exportChart('speciesChart')">Download Chart</button>
      </div>
    </div>

    <div class="card" style="display:none;" id="trendCard">
      <h3>Detection Trend Over Time</h3>
      <canvas id="trendChart"></canvas>
      <div class="export-btns">
        <button onclick="exportChart('trendChart')">Download Chart</button>
      </div>
    </div>

    <div class="card" style="display:none;" id="mapCard">
      <h3>Detection by Location</h3>
      <div id="map"></div>
      <div class="export-btns">
        <button onclick="exportMap()">Download Map</button>
      </div>
    </div>
  </div>

  <script>
    // Initialize map with a better default view for your data
    const map = L.map('map').setView([1.1, 37.4], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Export functions
    function exportChart(canvasId) {
      html2canvas(document.getElementById(canvasId)).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const pdf = new jspdf.jsPDF();
        pdf.addImage(imgData, 'PNG', 10, 10, 180, 90);
        pdf.save(canvasId + '.pdf');

        const link = document.createElement('a');
        link.download = canvasId + '.png';
        link.href = imgData;
        link.click();
      });
    }

    function exportMap() {
      html2canvas(document.getElementById("map")).then(canvas => {
        const imgData = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = "map.png";
        link.href = imgData;
        link.click();
      });
    }

    // CSV loading function
    function loadCSV(url) {
      return new Promise((resolve, reject) => {
        Papa.parse(url, {
          download: true,
          header: true,
          complete: (results) => {
            if (results.data && results.data.length > 0) {
              resolve(results.data.filter(row => Object.values(row).some(val => val !== '')));
            } else {
              reject(new Error("No data found in CSV"));
            }
          },
          error: (error) => {
            reject(error);
          }
        });
      });
    }

    // Dashboard rendering function
    function renderDashboard(data) {
      // Show loading message while processing
      document.getElementById('loading').textContent = "Processing data...";

      // Process species data
      const speciesCount = {};
      const dateCount = {};
      const songTypeCount = {};
      
      data.forEach(row => {
        // Process species data
        const species = row.scientific_name || "Unknown";
        speciesCount[species] = (speciesCount[species] || 0) + 1;

        // Process song type data
        const songType = row.songtype || "Unknown";
        songTypeCount[songType] = (songTypeCount[songType] || 0) + 1;

        // Process date data
        const date = row.recording_local_time ? row.recording_local_time.split(' ')[0] : "No date";
        dateCount[date] = (dateCount[date] || 0) + 1;

        // Add map markers
        const lat = parseFloat(row.site_latitude);
        const lng = parseFloat(row.site_longitude);
        if (!isNaN(lat) && !isNaN(lng)) {
          L.circleMarker([lat, lng], {
            radius: 5,
            color: '#e74c3c',
            fillOpacity: 0.8,
            fillColor: '#3498db'
          }).addTo(map).bindPopup(`
            <b>Species:</b> ${species}<br>
            <b>Date:</b> ${date}<br>
            <b>Song Type:</b> ${songType}<br>
            <b>Site:</b> ${row.site_name || 'Unknown'}
          `);
        }
      });

      // Sort dates chronologically
      const sortedDates = Object.keys(dateCount).sort((a, b) => new Date(a) - new Date(b));
      const sortedDateCount = {};
      sortedDates.forEach(date => {
        sortedDateCount[date] = dateCount[date];
      });

      // Create species chart
      new Chart(document.getElementById('speciesChart'), {
        type: 'bar',
        data: {
          labels: Object.keys(speciesCount),
          datasets: [{
            label: 'Detections',
            data: Object.values(speciesCount),
            backgroundColor: '#3498db',
            borderColor: '#2980b9',
            borderWidth: 1
          }]
        },
        options: { 
          responsive: true, 
          plugins: { 
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `${context.parsed.y} detections`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Detections'
              }
            }
          }
        }
      });

      // Create trend chart
      new Chart(document.getElementById('trendChart'), {
        type: 'line',
        data: {
          labels: Object.keys(sortedDateCount),
          datasets: [{
            label: 'Detections Over Time',
            data: Object.values(sortedDateCount),
            borderColor: '#e74c3c',
            backgroundColor: 'rgba(231, 76, 60, 0.1)',
            borderWidth: 2,
            tension: 0.1,
            fill: true
          }]
        },
        options: { 
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Detections'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            }
          }
        }
      });

      // Hide loading message and show cards
      document.getElementById('loading').style.display = 'none';
      document.getElementById('speciesCard').style.display = 'block';
      document.getElementById('trendCard').style.display = 'block';
      document.getElementById('mapCard').style.display = 'block';
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      const csvUrl = 'https://raw.githubusercontent.com/douglasmbura/dashboard/main/_templates.csv';
      
      loadCSV(csvUrl)
        .then(data => {
          if (data && data.length > 0) {
            renderDashboard(data);
          } else {
            document.getElementById('loading').textContent = "No data available";
          }
        })
        .catch(error => {
          console.error("Error loading data:", error);
          document.getElementById('loading').textContent = "Error loading data. Please check console for details.";
        });
    });
  </script>
</body>
</html>
